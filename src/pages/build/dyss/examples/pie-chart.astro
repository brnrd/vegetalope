---
import DyssExample from '../../../../layouts/DyssExample.astro';
import dyssPieDemoScript from '../../../../scripts/dyss-pie-demo.js?url&no-inline';

const title = 'dyss: dynamic pie chart playground';
const description = 'A small dyss use-case: tweak pie chart inputs and let CSS update itself.';
---

<DyssExample title={title} description={description}>
	<p>
		This version keeps the chart semantic first: the pie is an actual list of entries, each item exposing
		<code>data-percentage</code> and <code>data-color</code>.
	</p>

	<p>
		The controls update those list items live, and the chart redraws from the same HTML data structure.
	</p>

	<div class="dyss-demo stack" data-dyss-demo>
		<form class="dyss-controls stack" data-dyss-controls>
			<fieldset>
				<legend>Pie chart values</legend>
				<div class="dyss-rows stack" data-dyss-rows></div>
				<div class="dyss-actions">
					<button type="button" data-dyss-add>Add service</button>
				</div>
			</fieldset>
		</form>

		<div class="dyss-preview stack">
			<figure class="dyss-chart-wrap">
				<ul class="dyss-pie" data-dyss-pie aria-label="Revenue split pie chart data"></ul>
				<figcaption>Revenue split</figcaption>
				<div class="dyss-runtime">
					<button type="button" data-dyss-live aria-pressed="false">Start live data</button>
					<label class="dyss-interval">
						<span>Interval</span>
						<select data-dyss-interval>
							<option value="1">1ms</option>
							<option value="10">10ms</option>
							<option value="50" selected>50ms</option>
							<option value="100">100ms</option>
							<option value="500">500ms</option>
							<option value="1000">1000ms</option>
						</select>
					</label>
					<p data-dyss-fps>0.0 FPS</p>
				</div>
			</figure>
		</div>

		<section class="dyss-code stack" aria-label="Live code preview">
			<h3>Live code</h3>
			<pre><code data-dyss-code></code></pre>
		</section>
	</div>

	<p class="dyss-note">
		CSS-Tricks reference:
		<a href="https://css-tricks.com/trying-to-make-the-perfect-pie-chart-in-css/">
			Trying to make the perfect pie chart in CSS
		</a>
	</p>

	<script slot="scripts" type="module" src={dyssPieDemoScript}></script>
</DyssExample>

<style>
	.dyss-demo {
		padding: 1rem;
		border: 1px solid var(--hairline);
		border-radius: 0.75rem;
		background: color-mix(in oklab, var(--color-bg) 92%, white);
	}

	.dyss-controls fieldset {
		border: 1px solid var(--hairline);
		padding: 0.9rem;
		margin: 0;
	}

	.dyss-controls legend {
		font-family: var(--font-label);
		font-size: 0.72rem;
		letter-spacing: 0.12em;
		text-transform: uppercase;
	}

	.dyss-rows {
		margin-top: 0.5rem;
	}

	:global(.dyss-row) {
		display: grid;
		grid-template-columns: minmax(110px, 160px) 1fr 48px 154px auto;
		gap: 0.5rem;
		align-items: center;
	}

	:global(.dyss-row input[data-field='label']) {
		inline-size: 100%;
	}

	:global(.dyss-row input[type='range']) {
		inline-size: 100%;
	}

	:global(.dyss-row output) {
		font-family: var(--font-label);
		font-size: 0.8rem;
		text-align: right;
	}

	:global(.dyss-color-pair) {
		--picker-size: 46px;
		--hex-size: 108px;
		display: grid;
		grid-template-columns: var(--picker-size) var(--hex-size);
		inline-size: calc(var(--picker-size) + var(--hex-size));
		gap: 0;
		align-items: center;
	}

	:global(.dyss-color-pair input[type='color']) {
		inline-size: 46px;
		block-size: 34px;
		padding: 0;
		border: 1px solid var(--hairline);
		border-right: 0;
		border-radius: 0.35rem 0 0 0.35rem;
		background: transparent;
	}

	:global(.dyss-hex-wrap) {
		position: relative;
		display: inline-flex;
	}

	:global(.dyss-hex-wrap)::before {
		content: '#';
		position: absolute;
		inset-inline-start: 0.5rem;
		inset-block-start: 50%;
		transform: translateY(-50%);
		font-family: var(--font-label);
		font-size: 0.72rem;
		color: var(--color-ink-muted);
		pointer-events: none;
	}

	:global(.dyss-hex-wrap input[data-field='colorHex']) {
		inline-size: 100%;
		block-size: 34px;
		padding-inline: 1.1rem 0.5rem;
		border: 1px solid var(--hairline);
		border-radius: 0 0.35rem 0.35rem 0;
		font-family: var(--font-label);
		font-size: 0.72rem;
		letter-spacing: 0.06em;
		text-transform: lowercase;
	}

	:global(.dyss-row button) {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		block-size: 34px;
		padding: 0.45rem 0.6rem;
		font-size: 0.62rem;
		background: transparent;
		color: var(--color-ink);
		border: 1px solid var(--hairline);
	}

	.dyss-actions {
		margin-top: 0.8rem;
	}

	.dyss-actions button {
		padding: 0.45rem 0.75rem;
		font-size: 0.62rem;
		background: transparent;
		color: var(--color-ink);
		border: 1px solid var(--hairline);
	}

	.dyss-actions button:hover,
	:global(.dyss-row button:hover) {
		background: color-mix(in oklab, var(--color-bg) 78%, var(--color-ink) 22%);
		color: var(--color-ink);
	}

	:global(.dyss-row button[disabled]) {
		opacity: 0.55;
		cursor: not-allowed;
	}

	.dyss-code {
		margin-top: 1rem;
	}

	.dyss-code h3 {
		font-size: 1rem;
		margin: 0;
	}

	.dyss-code pre {
		margin: 0;
		font-size: 0.8rem;
		line-height: 1.5;
		max-block-size: 280px;
	}

	.dyss-preview {
		margin-top: 1rem;
		display: grid;
		grid-template-columns: 1fr;
		gap: 1rem;
		align-items: start;
	}

	.dyss-chart-wrap {
		margin: 0;
		display: grid;
		gap: 0.7rem;
		justify-items: center;
		width: fit-content;
		padding: 2.6rem 3rem 0.35rem;
	}

	.dyss-chart-wrap figcaption {
		font-size: 0.82rem;
		color: var(--color-ink-muted);
	}

	.dyss-runtime {
		display: inline-flex;
		align-items: center;
		gap: 0.6rem;
		flex-wrap: wrap;
	}

	.dyss-runtime button {
		padding: 0.4rem 0.65rem;
		font-size: 0.62rem;
		background: var(--color-bg);
		color: var(--color-ink);
		border: 1px solid var(--hairline);
	}

	.dyss-runtime button:hover {
		background: color-mix(in oklab, var(--color-bg) 75%, var(--color-ink) 25%);
		color: var(--color-ink);
	}

	.dyss-runtime button[aria-pressed='true'] {
		background: var(--color-ink);
		color: var(--color-bg);
	}

	.dyss-runtime p {
		margin: 0;
		font-family: var(--font-label);
		font-size: 0.68rem;
		letter-spacing: 0.1em;
		text-transform: uppercase;
	}

	.dyss-interval {
		display: inline-flex;
		align-items: center;
		gap: 0.4rem;
		font-family: var(--font-label);
		font-size: 0.62rem;
		letter-spacing: 0.1em;
		text-transform: uppercase;
	}

	.dyss-interval select {
		padding: 0.3rem 0.45rem;
		background: var(--color-bg);
		color: var(--color-ink);
		border: 1px solid var(--hairline);
		border-radius: 0;
	}

	.dyss-pie {
		--radius: min(22vmin, 110px);
		--gap: 2.1rem;
		list-style: none;
		margin: 0;
		padding: 0;
		display: grid;
		place-items: center;
		position: relative;
		inline-size: calc(var(--radius) * 2);
		aspect-ratio: 1 / 1;
		border-radius: 50%;
		border: 0;
		background: transparent;
		box-shadow: none;
		overflow: visible;
	}

	:global(.dyss-pie-item) {
		--accum: 0;
		--weighing: 0;
		--percentage: 0%;
		--bg-color: #d9d9d9;
		--slice-overlap: 0.18%;
		--layer: 1;
		--offset: calc(360deg * var(--accum) / 100);
		--theta: calc((360deg * var(--weighing)) / 2 + var(--offset) - 90deg);
		--pos-x: calc(cos(var(--theta)) * (var(--radius) + var(--gap)));
		--pos-y: calc(sin(var(--theta)) * (var(--radius) + var(--gap)));
		grid-row: 1;
		grid-column: 1;
		z-index: var(--layer);
		inline-size: calc(var(--radius) * 2);
		aspect-ratio: 1 / 1;
		border-radius: 50%;
		display: grid;
		place-items: center;
		background: conic-gradient(
			from var(--offset),
			var(--bg-color) 0% calc(var(--percentage) + var(--slice-overlap)),
			transparent calc(var(--percentage) + var(--slice-overlap)) 100%
		);
	}

	:global(.dyss-pie-item[data-explode='true']) {
		transform: translate(0, 3px);
	}

	:global(.dyss-pie-item strong),
	:global(.dyss-pie-item::after) {
		grid-row: 1;
		grid-column: 1;
		background: color-mix(in oklab, var(--color-bg) 85%, white);
		padding: 0.1rem 0.35rem;
		border: 1px solid var(--hairline);
		font-size: 0.66rem;
		line-height: 1.2;
		white-space: nowrap;
	}

	:global(.dyss-pie-item strong) {
		font-size: 0.68rem;
		font-weight: 600;
		transform: translateX(var(--pos-x)) translateY(var(--pos-y));
	}

	:global(.dyss-pie-item::after) {
		content: attr(data-percentage) '%';
		--pos-y: calc(sin(var(--theta)) * (var(--radius) + var(--gap)) + 1.4lh);
		transform: translateX(var(--pos-x)) translateY(var(--pos-y));
		color: var(--color-ink-muted);
	}

	.dyss-note {
		font-size: 0.88rem;
		color: var(--color-ink-muted);
	}

	@media (max-width: 900px) {
		:global(.dyss-row) {
			grid-template-columns: 1fr;
		}

		:global(.dyss-row output) {
			text-align: left;
		}

		.dyss-pie {
			--gap: 1.5rem;
		}

		.dyss-chart-wrap {
			padding: 2rem 1.8rem 0.2rem;
		}
	}

	@media (min-width: 1080px) {
		.dyss-runtime {
			inline-size: min(520px, 100%);
			justify-content: space-between;
			gap: 0.9rem;
		}

		.dyss-runtime p {
			margin-left: auto;
			text-align: right;
		}
	}
</style>
